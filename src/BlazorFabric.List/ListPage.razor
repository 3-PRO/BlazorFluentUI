@using System.Reactive.Subjects
@using System.Reactive.Linq
@using Microsoft.JSInterop
@using BlazorFabric.BaseComponent

@inherits FabricComponentBase

@typeparam TItem

@inject IJSRuntime JSRuntime

<div @ref="RootElementReference" @ref:suppressField role="presentation">
    @{
        var index = StartIndex;
        foreach (var item in this.ItemsSource)
        {
            <ListItem IndexPosition=@index Item=@item ItemClicked=@ItemClicked IsActive=@(this.SelectedItems.Contains(item))>
                @ItemTemplate(item)
            </ListItem>
            index++;
        }
    }
</div>

@functions{
    //private BehaviorSubject<double> heightSubject;

    public double Width { get; set; }
    public double Height { get; set; }
    //public IObservable<double> Height { get => this.heightSubject.AsObservable(); }

    [Parameter] RenderFragment<TItem> ItemTemplate { get; set; }

    [Parameter] IEnumerable<TItem> ItemsSource { get; set; }

    [Parameter] int StartIndex { get; set; }

    [Parameter] ISubject<(int index, double height)> PageMeasureSubject { get; set; }

    [Parameter]
    private Func<object, UIMouseEventArgs, Task> ItemClicked { get; set; }


    [Parameter] IEnumerable<TItem> SelectedItems { get; set; }


    protected override Task OnInitializedAsync()
    {
        //this.heightSubject = new BehaviorSubject<double>(0);
        return base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync()
    {
        var result = await JSRuntime.InvokeAsync<Dictionary<string, double>>("BlazorFabricList.measureElementRect", RootElementReference);
        this.Width = result["width"];
        this.Height = result["height"];
        //this.heightSubject.OnNext(result["height"]);
        this.PageMeasureSubject.OnNext((this.StartIndex, this.Height));
        await base.OnAfterRenderAsync();
    }
}